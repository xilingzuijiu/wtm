<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!--<meta http-equiv="refresh" content="10">-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0" name="viewport"/>
    <title>阅读列表</title>
    <link href="../code/css/base.css" rel="stylesheet" type="text/css"/>
    <link href="../code/css/style.css" rel="stylesheet" type="text/css"/>
    <script src="../code/js/jquery.min.js"></script>
    <script src="../code/js/jquery.cookie.js"></script>
    <script>
        var memberId;
        var requestTime;
        var articleId;
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null)return unescape(r[2]);
            return null;
        }
        var hashMap = {
            Set: function (key, value) {
                this[key] = value
            },
            Get: function (key) {
                return this[key]
            },
            Contains: function (key) {
                return this.Get(key) == null ? false : true
            },
            Remove: function (key) {
                delete this[key]
            }
        }

        function is_weixin(){
            var ua = navigator.userAgent.toLowerCase();
            if(ua.match(/MicroMessenger/i)=="micromessenger") {
                return true;
            } else {
                return false;
            }
        }

        $(function () {
            if(is_weixin()){
                var u = navigator.userAgent;
                var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1;//android终端
                var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);// ios终端
                memberId = GetQueryString('memberId');
                requestTime = GetQueryString('requestTime');
                console.log(memberId);
                console.log(requestTime);
                $.ajax({
                    type: 'post',
                    url: '/pc/admin/member/getArticleList',
                    data: {memberId: memberId, requestTime: requestTime},
                    header: {
                        "Access-Control-Allow-Origin": "true"
                    },
                    success: function (params) {
                        var json = eval(params); //数组
                        console.log("json数据为：" + params)
                        if (json != null && json.errorCode == 0) {
                            var leng = json.data.length;
                            for (var i = 0; i < leng; i++) {
                                var timestamp = json.data[i].createTime;

                                function add0(m) {
                                    return m < 10 ? '0' + m : m
                                }

                                function format(timestamp) {
                                    var time = new Date(timestamp * 1000);
                                    var y = time.getFullYear();
                                    var m = time.getMonth() + 1;
                                    var d = time.getDate();
                                    var h = time.getHours();
                                    var mm = time.getMinutes();
                                    var s = time.getSeconds();
                                    return add0(m) + '/' + add0(d) + ' ' + add0(h) + ':' + add0(mm);
                                }//时间戳变换格式
                                var li = document.createElement('li');
                                li.setAttribute("onClick", "articleSubmit(this)")
//                            a.setAttribute("href",'javascript:articleSubmit()');
                                li.id = json.data[i].articleId;
                                hashMap.Set(li.id, json.data[i].articleUrl);
                                //var a=document.createElement('a');
                                var div1 = document.createElement('div');
                                div1.className = "tablebox";
                                var img = document.createElement('img');
                                img.className = "logo";
                                img.setAttribute("src", json.data[i].imageUrl);
                                var div2 = document.createElement('div');
                                div2.className = "readcont";
                                var h3 = document.createElement('h3');
                                h3.innerHTML = json.data[i].title;
                                var p1 = document.createElement('p');
                                p1.innerHTML = json.data[i].articleAbstract;
                                var div3 = document.createElement('div');
                                div3.className = "readtool";
                                var p2 = document.createElement('p');
                                p2.className = "thistime";
                                p2.innerHTML = format(timestamp);
                                var p3 = document.createElement('p');
                                p3.className = "clickcount";
                                p3.innerHTML = "点击：";
                                var span = document.createElement('span');
                                span.innerHTML = json.data[i].singleScore + "米";
                                div2.appendChild(h3);
                                div2.appendChild(p1)
                                div1.appendChild(img);
                                div1.appendChild(div2);
                                li.appendChild(div1);
                                li.appendChild(div3);
                                p3.appendChild(span);
                                div3.appendChild(p2);
                                div3.appendChild(p3);
                                document.body.appendChild(li);
                                document.getElementsByTagName('ul')[0].appendChild(li);//动态添加文章（li标签）

                            }
                        } else {
                            alert("获取数据失败")
                        }
                        $.cookie(memberId+requestTime,0);
                    },
                    error: function (data) {
                        console.log(data)
                        alert("页面加载错误，请重试");
                    }
                });
                if (isiOS) {
                    reurl()
                }
            }else {
                $(".readlist").empty()
                document.body.innerHTML="请在微信打开此页面"
            }
        })
        var articleSubmit = function (obj) {
            var articleId = obj.getAttribute("id");
            //var index=obj.index();

//            var obj= a.parentNode;
            var articleUrl = hashMap.Get(articleId);
            console.log(articleId);
            $.ajax({
                type: 'post',
                url: '/pc/admin/member/readArticleRequest',
                data: {memberId: memberId, requestTime: requestTime, articleId: articleId},
                header: {
                    "Access-Control-Allow-Origin": "true"
                },
                success: function (params) {
                    var json = eval(params); //数组
                    console.log("json数据为：" + params)
                    if (json != null && json.errorCode == 0) {
                        obj.remove()
                        $.cookie(memberId+requestTime,'',{expires:-1})
//                        obj.style.display = 'none';
//                        window.open(articleUrl)
                        location.href = articleUrl;
//
                    } else if (json != null && json.errorCode == 4) {
                        alert(json.message)
                    } else {
                        alert("获取数据失败")
                    }
                },
                error: function (data) {
                    console.log(data)
                    alert("页面加载错误，请重试");
                }
            })
        }
        function reurl() {
            if ($.cookie(memberId+requestTime)==null||$.cookie(memberId+requestTime)==undefined){
                $.cookie(memberId+requestTime,0);
                location.reload()
            }
        }
    </script>
</head>
<body>
<ul class="readlist">
    <!--<li>-->
    <!--<a href="https://www.baidu.com/?tn=39042058_19_oem_dg">-->
    <!--<div class="tablebox">-->
    <!--<img class="logo" src="../code/img/76pt-2x.png"/>-->
    <!--<div class="readcont">-->
    <!--<h3>腾讯新闻</h3>-->
    <!--<p>台黑帮大佬遭枪杀3000人送葬</p>-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="readtool">-->
    <!--<p class="thistime">08:39</p>-->
    <!--<p class="clickcount">点击：<span>0.05米</span></p>-->
    <!--</div>-->
    <!--</a></li>-->
</ul>
<!--<div class="showone">-->
<!--<iframe src="" frameborder="0" width="100%" height="100%" scrolling="auto">-->
<!--<a href="">你的浏览器不支持iframe页面嵌套，请点击这里访问页面内容。</a>-->
<!--</iframe>-->

<!--</div>-->
<!--<div class="hideone">></div>-->
</body>
</html>